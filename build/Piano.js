!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("tone")):"function"==typeof define&&define.amd?define(["tone"],e):"object"==typeof exports?exports.Tone=e(require("tone")):t.Tone=e(t.tone)}(self,(t=>(()=>{"use strict";var e={583:e=>{e.exports=t}},s={};function i(t){var o=s[t];if(void 0!==o)return o.exports;var n=s[t]={exports:{}};return e[t](n,n.exports,i),n.exports}i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};return(()=>{i.r(o),i.d(o,{Piano:()=>_});var t=i(583);class e extends t.ToneAudioNode{constructor(e){super(e),this.name="PianoComponent",this.input=void 0,this.output=new t.Volume({context:this.context}),this._enabled=!1,this.volume=this.output.volume,this._loaded=!1,this.volume.value=e.volume,this._enabled=e.enabled,this.samples=e.samples}get loaded(){return this._loaded}load(){return t=this,e=void 0,i=function*(){if(!this._enabled)return Promise.resolve();yield this._internalLoad(),this._loaded=!0},new((s=void 0)||(s=Promise))((function(o,n){function r(t){try{l(i.next(t))}catch(t){n(t)}}function a(t){try{l(i.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}));var t,e,s,i}}function s(e){return(0,t.Frequency)(e,"midi").toNote()}function n(t,e){return Math.random()*(e-t)+t}const r={1:[8],2:[6,12],3:[1,7,15],4:[1,5,10,15],5:[1,4,8,12,16],6:[1,3,7,10,13,16],7:[1,3,6,9,11,13,16],8:[1,3,5,7,9,11,13,16],9:[1,3,5,7,9,11,13,15,16],10:[1,2,3,5,7,9,11,13,15,16],11:[1,2,3,5,7,9,11,13,14,15,16],12:[1,2,3,4,5,7,9,11,13,14,15,16],13:[1,2,3,4,5,7,9,11,12,13,14,15,16],14:[1,2,3,4,5,6,7,9,11,12,13,14,15,16],15:[1,2,3,4,5,6,7,9,10,11,12,13,14,15,16],16:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]},a=[21,24,27,30,33,36,39,42,45,48,51,54,57,60,63,66,69,72,75,78,81,84,87,90,93,96,99,102,105,108],l=[21,24,27,30,33,36,39,42,45,48,51,54,57,60,63,66,69,72,75,78,81,84,87];class h extends e{constructor(t){super(t),this._urls={};const e=(i=t.minNote,o=t.maxNote,l.filter((t=>i<=t&&t<=o)));var i,o;for(const t of e)this._urls[t]=`harmS${s(t).replace("#","s")}.[mp3|ogg]`}triggerAttack(e,s,i){this._enabled&&function(t){return l[0]<=t&&t<=l[l.length-1]}(e)&&this._sampler.triggerAttack((0,t.Midi)(e).toNote(),s,i*n(.5,1))}_internalLoad(){return new Promise((e=>{this._sampler=new t.Sampler({baseUrl:this.samples,onload:e,urls:this._urls}).connect(this.output)}))}}class u extends e{constructor(t){super(t),this._urls={};for(let e=t.minNote;e<=t.maxNote;e++)this._urls[e]=`rel${e-20}.[mp3|ogg]`}_internalLoad(){return new Promise((e=>{this._buffers=new t.ToneAudioBuffers(this._urls,e,this.samples)}))}start(e,s,i){this._enabled&&this._buffers.has(e)&&new t.ToneBufferSource({url:this._buffers.get(e),context:this.context}).connect(this.output).start(s,0,void 0,.015*i*n(.5,1))}}class d extends e{constructor(t){super(t),this._downTime=1/0,this._currentSound=null,this._downTime=1/0}_internalLoad(){return new Promise((e=>{this._buffers=new t.ToneAudioBuffers({down1:"pedalD1.mp3",down2:"pedalD2.mp3",up1:"pedalU1.mp3",up2:"pedalU2.mp3"},e,this.samples)}))}_squash(t){this._currentSound&&"stopped"!==this._currentSound.state&&this._currentSound.stop(t),this._currentSound=null}_playSample(e,s){this._enabled&&(this._currentSound=new t.ToneBufferSource({url:this._buffers.get(`${s}${Math.random()>.5?1:2}`),context:this.context,curve:"exponential",fadeIn:.05,fadeOut:.1}).connect(this.output),this._currentSound.start(e,n(0,.01),void 0,.1*n(.5,1)))}down(t){this._squash(t),this._downTime=t,this._playSample(t,"down")}up(t){this._squash(t),this._downTime=1/0,this._playSample(t,"up")}isDown(t){return t>this._downTime}}class c extends t.ToneAudioNode{constructor(t){super(t),this.name="PianoString",this._urls={},t.notes.forEach((e=>{return this._urls[e]=(i=e,o=t.velocity,`${s(i).replace("#","s")}v${o}.[mp3|ogg]`);var i,o})),this.samples=t.samples}load(){return new Promise((e=>{this._sampler=this.output=new t.Sampler({attack:0,baseUrl:this.samples,curve:"exponential",onload:e,release:.4,urls:this._urls,volume:3})}))}triggerAttack(t,e,s){this._sampler.triggerAttack(t,e,s)}triggerRelease(t,e){this._sampler.triggerRelease(t,e)}}var p=function(t,e,s,i){return new(s||(s=Promise))((function(o,n){function r(t){try{l(i.next(t))}catch(t){n(t)}}function a(t){try{l(i.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}))};class m extends e{constructor(t){super(t);const e=(s=t.minNote,i=t.maxNote,a.filter((t=>s<=t&&t<=i)));var s,i;const o=r[t.velocities].slice();this._strings=o.map((s=>new c(Object.assign(t,{notes:e,velocity:s})))),this._activeNotes=new Map}scale(t,e,s,i,o){return(t-e)/(s-e)*(o-i)+i}triggerAttack(e,s,i){const o=this.scale(i,0,1,-.5,this._strings.length-.51),n=Math.max(Math.round(o),0);let r=1+o-n;1===this._strings.length&&(r=i);const a=this._strings[n];this._activeNotes.has(e)&&this.triggerRelease(e,s),this._activeNotes.set(e,a),a.triggerAttack((0,t.Midi)(e).toNote(),s,r)}triggerRelease(e,s){this._activeNotes.has(e)&&(this._activeNotes.get(e).triggerRelease((0,t.Midi)(e).toNote(),s),this._activeNotes.delete(e))}_internalLoad(){return p(this,void 0,void 0,(function*(){yield Promise.all(this._strings.map((t=>p(this,void 0,void 0,(function*(){yield t.load(),t.connect(this.output)})))))}))}}class _ extends t.ToneAudioNode{constructor(){super((0,t.optionsFromArguments)(_.getDefaults(),arguments)),this.name="Piano",this.input=void 0,this.output=new t.Gain({context:this.context}),this._heldNotes=new Map,this._loaded=!1;const e=(0,t.optionsFromArguments)(_.getDefaults(),arguments);e.url.endsWith("/")||(e.url+="/"),this.maxPolyphony=e.maxPolyphony,this._heldNotes=new Map,this._sustainedNotes=new Map,this._strings=new m(Object.assign({},e,{enabled:!0,samples:e.url,volume:e.volume.strings})).connect(this.output),this.strings=this._strings.volume,this._pedal=new d(Object.assign({},e,{enabled:e.pedal,samples:e.url,volume:e.volume.pedal})).connect(this.output),this.pedal=this._pedal.volume,this._keybed=new u(Object.assign({},e,{enabled:e.release,samples:e.url,volume:e.volume.keybed})).connect(this.output),this.keybed=this._keybed.volume,this._harmonics=new h(Object.assign({},e,{enabled:e.release,samples:e.url,volume:e.volume.harmonics})).connect(this.output),this.harmonics=this._harmonics.volume}static getDefaults(){return Object.assign(t.ToneAudioNode.getDefaults(),{maxNote:108,minNote:21,pedal:!0,release:!1,url:"https://tambien.github.io/Piano/audio/",velocities:1,maxPolyphony:32,volume:{harmonics:0,keybed:0,pedal:0,strings:0}})}load(){return t=this,e=void 0,i=function*(){yield Promise.all([this._strings.load(),this._pedal.load(),this._keybed.load(),this._harmonics.load()]),this._loaded=!0},new((s=void 0)||(s=Promise))((function(o,n){function r(t){try{l(i.next(t))}catch(t){n(t)}}function a(t){try{l(i.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?o(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,a)}l((i=i.apply(t,e||[])).next())}));var t,e,s,i}get loaded(){return this._loaded}pedalDown({time:t=this.immediate()}={}){return this.loaded&&(t=this.toSeconds(t),this._pedal.isDown(t)||this._pedal.down(t)),this}pedalUp({time:t=this.immediate()}={}){if(this.loaded){const e=this.toSeconds(t);this._pedal.isDown(e)&&(this._pedal.up(e),this._sustainedNotes.forEach(((t,s)=>{this._heldNotes.has(s)||this._strings.triggerRelease(s,e)})),this._sustainedNotes.clear())}return this}keyDown({note:e,midi:s,time:i=this.immediate(),velocity:o=.8}){return this.loaded&&this.maxPolyphony>this._heldNotes.size+this._sustainedNotes.size?(i=this.toSeconds(i),(0,t.isString)(e)&&(s=Math.round((0,t.Midi)(e).toMidi())),this._heldNotes.has(s)||(this._heldNotes.set(s,{time:i,velocity:o}),this._strings.triggerAttack(s,i,o))):console.warn("samples not loaded"),this}keyUp({note:e,midi:s,time:i=this.immediate(),velocity:o=.8}){if(this.loaded&&(i=this.toSeconds(i),(0,t.isString)(e)&&(s=Math.round((0,t.Midi)(e).toMidi())),this._heldNotes.has(s))){const t=this._heldNotes.get(s);this._heldNotes.delete(s);let e=3/Math.pow(Math.max(i-t.time,.1),.7)*t.velocity*o;e=Math.max(e,.4),e=Math.min(e,4),this._pedal.isDown(i)?this._sustainedNotes.has(s)||this._sustainedNotes.set(s,i):(this._strings.triggerRelease(s,i),this._harmonics.triggerAttack(s,i,e)),this._keybed.start(s,i,o)}return this}stopAll(){return this.pedalUp(),this._heldNotes.forEach(((t,e)=>{this.keyUp({midi:e})})),this}}})(),o})()));
//# sourceMappingURL=Piano.js.map